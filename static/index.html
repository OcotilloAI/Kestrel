<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kestrel - Voice Agent</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        header {
            background-color: #fff;
            padding: 15px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-weight: bold;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #status {
            font-size: 0.8rem;
            color: #666;
            padding: 4px 8px;
            background: #eee;
            border-radius: 4px;
        }

        /* Chat Area */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }

        .user-msg {
            align-self: flex-end;
            background-color: #007aff;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .agent-msg {
            align-self: flex-start;
            background-color: #e5e5ea;
            color: black;
            border-bottom-left-radius: 4px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Input Area */
        #input-area {
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #preview {
            color: #666;
            font-style: italic;
            min-height: 20px;
            font-size: 0.9rem;
        }

        #controls {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 24px;
            background-color: #007aff;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:disabled {
            background-color: #ccc;
        }

        button.recording {
            background-color: #ff3b30;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body>

<header>
    <div>Kestrel</div>
    <div id="status">Disconnected</div>
</header>

<div id="chat-container">
    <div class="message agent-msg">Hello! I am Goose. Click 'Start' to talk to me.</div>
</div>

<div id="input-area">
    <div id="preview">Ready...</div>
    <div id="controls">
        <button id="toggle-btn">Start Listening</button>
    </div>
</div>

<script>
    const statusEl = document.getElementById('status');
    const chatEl = document.getElementById('chat-container');
    const previewEl = document.getElementById('preview');
    const toggleBtn = document.getElementById('toggle-btn');

    // WebSocket
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
    let socket;

    // Speech Recognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isRecording = false;

    // TTS
    const synth = window.speechSynthesis;

    function connect() {
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            statusEl.innerText = "Connected";
            statusEl.style.color = "green";
        };

        socket.onmessage = (event) => {
            const text = event.data;
            if (text.startsWith("G: ")) {
                const msg = text.substring(3);
                addMessage(msg, 'agent');
                speak(msg);
            }
        };

        socket.onclose = () => {
            statusEl.innerText = "Disconnected";
            statusEl.style.color = "red";
            setTimeout(connect, 3000); // Reconnect
        };
    }

    function initSpeech() {
        if (!SpeechRecognition) {
            alert("Your browser does not support Speech Recognition. Try Chrome or Safari.");
            return;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = false; // Stop after one sentence to send
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
            isRecording = true;
            toggleBtn.innerText = "Stop Listening";
            toggleBtn.classList.add("recording");
            previewEl.innerText = "Listening...";
        };

        recognition.onend = () => {
            isRecording = false;
            toggleBtn.innerText = "Start Listening";
            toggleBtn.classList.remove("recording");
            // If we want continuous convos, we might restart here automatically
            // unless the user explicitly stopped it.
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }

            if (interimTranscript) {
                previewEl.innerText = interimTranscript;
            }

            if (finalTranscript) {
                previewEl.innerText = "Sending: " + finalTranscript;
                addMessage(finalTranscript, 'user');
                socket.send(finalTranscript);
            }
        };
        
        recognition.onerror = (event) => {
            console.error("Speech Error", event.error);
            previewEl.innerText = "Error: " + event.error;
        };
    }

    function toggleRecording() {
        if (isRecording) {
            recognition.stop();
        } else {
            recognition.start();
        }
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.classList.add('message');
        div.classList.add(sender === 'user' ? 'user-msg' : 'agent-msg');
        div.innerText = text;
        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
    }

    function speak(text) {
        // Strip basic ANSI or markdown if present (simple check)
        const cleanText = text.replace(/[*#]/g, ''); 
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.rate = 1.0;
        synth.speak(utterance);
    }

    // Init
    connect();
    initSpeech();

    toggleBtn.addEventListener('click', toggleRecording);

</script>
</body>
</html>
